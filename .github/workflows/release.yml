name: Release and Version

on:
  push:
    branches:
      - main

jobs:
  release:
    name: Create Release and Version
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get latest tag
        id: get_latest_tag
        run: |
          # Get the latest tag or default to v0.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest tag: $LATEST_TAG"

      - name: Determine version bump
        id: version_bump
        run: |
          # Analyze commit messages since last tag
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"

          # Get commit messages since last tag
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%s" HEAD)
          else
            COMMITS=$(git log --pretty=format:"%s" ${LATEST_TAG}..HEAD)
          fi

          echo "Commits since $LATEST_TAG:"
          echo "$COMMITS"

          # Determine version bump type
          BUMP_TYPE="none"

          # Check for breaking changes (MAJOR)
          # Matches: feat!:, BREAKING CHANGE, breaking:, etc.
          if echo "$COMMITS" | grep -qiE "^(feat|fix|chore)(\(.*\))?!:|^breaking:|BREAKING CHANGE"; then
            BUMP_TYPE="major"
          # Check for features (MINOR)
          elif echo "$COMMITS" | grep -qiE "^(feat|feature)(\(.*\))?:"; then
            BUMP_TYPE="minor"
          # Check for fixes and other changes (PATCH)
          elif echo "$COMMITS" | grep -qiE "^(fix|chore|docs|style|refactor|perf|test)(\(.*\))?:"; then
            BUMP_TYPE="patch"
          fi

          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "Version bump type: $BUMP_TYPE"

      - name: Calculate new version
        id: new_version
        run: |
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
          BUMP_TYPE="${{ steps.version_bump.outputs.bump_type }}"

          # Remove 'v' prefix and split version
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Default to 0 if empty
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}

          # Bump version based on type
          if [ "$BUMP_TYPE" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP_TYPE" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          elif [ "$BUMP_TYPE" = "patch" ]; then
            PATCH=$((PATCH + 1))
          else
            echo "No version bump needed"
            echo "should_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "should_release=true" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update package.json versions
        if: steps.new_version.outputs.should_release == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          VERSION_NUMBER=${NEW_VERSION#v}

          # Update root package.json
          if [ -f "package.json" ]; then
            sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" package.json
          fi

          # Update backend package.json
          if [ -f "backend/package.json" ]; then
            sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" backend/package.json
          fi

          # Update frontend package.json
          if [ -f "frontend/package.json" ]; then
            sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" frontend/package.json
          fi

      - name: Generate changelog entry
        if: steps.new_version.outputs.should_release == 'true'
        id: changelog
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"

          # Get commits since last tag
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" ${LATEST_TAG}..HEAD)
          fi

          # Create changelog entry
          echo "## [$NEW_VERSION] - $(date +%Y-%m-%d)" > /tmp/changelog_entry.md
          echo "" >> /tmp/changelog_entry.md
          echo "### Changes" >> /tmp/changelog_entry.md
          echo "$COMMITS" >> /tmp/changelog_entry.md
          echo "" >> /tmp/changelog_entry.md

          # Prepend to CHANGELOG.md after the "Unreleased" section
          if [ -f "CHANGELOG.md" ]; then
            # Find line number of first version entry
            LINE=$(grep -n "^## \[" CHANGELOG.md | grep -v "Unreleased" | head -1 | cut -d: -f1)
            if [ -n "$LINE" ]; then
              # Insert new entry before first version
              head -n $((LINE - 1)) CHANGELOG.md > /tmp/changelog_temp.md
              cat /tmp/changelog_entry.md >> /tmp/changelog_temp.md
              tail -n +$LINE CHANGELOG.md >> /tmp/changelog_temp.md
              mv /tmp/changelog_temp.md CHANGELOG.md
            else
              # No version entries yet, append to end
              cat /tmp/changelog_entry.md >> CHANGELOG.md
            fi
          fi

      - name: Commit version bump
        if: steps.new_version.outputs.should_release == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"

          git add package.json backend/package.json frontend/package.json CHANGELOG.md 2>/dev/null || true
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]" || echo "No changes to commit"
          git push origin main

      - name: Create Git tag
        if: steps.new_version.outputs.should_release == 'true'
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
          git push origin "$NEW_VERSION"

      - name: Create GitHub Release
        if: steps.new_version.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.new_version.outputs.new_version }}
          name: Release ${{ steps.new_version.outputs.new_version }}
          body_path: /tmp/changelog_entry.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.new_version.outputs.should_release == 'true'
        run: |
          echo "### Release Created! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.new_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ steps.version_bump.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See the [release page](https://github.com/${{ github.repository }}/releases/tag/${{ steps.new_version.outputs.new_version }}) for details." >> $GITHUB_STEP_SUMMARY
