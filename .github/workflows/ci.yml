name: CI - Test & Lint

on:
  pull_request:
    branches:
      - main

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install --prefer-offline

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install --prefer-offline

      - name: Lint backend
        working-directory: ./backend
        run: npm run lint || echo "No lint script, skipping"
        continue-on-error: true

      - name: Lint frontend
        working-directory: ./frontend
        run: npm run lint || echo "No lint script, skipping"
        continue-on-error: true

  build:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm install --prefer-offline

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install --prefer-offline

      - name: Build backend
        working-directory: ./backend
        run: |
          echo "Backend build check - verifying structure"
          test -f src/server.js || exit 1
          test -f src/services/fplApi.js || exit 1
          test -f src/routes/index.js || exit 1
          echo "✓ Backend structure verified"

      - name: Build frontend
        working-directory: ./frontend
        run: |
          npm run build
          echo "✓ Frontend build successful"

      - name: Run backend tests
        working-directory: ./backend
        run: npm test || echo "No tests configured yet"
        continue-on-error: true

      - name: Run frontend tests
        working-directory: ./frontend
        run: npm test || echo "No tests configured yet"
        continue-on-error: true

  docker:
    name: Docker Build Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: fpl-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: false
          tags: fpl-frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: |
          docker compose config > /dev/null
          echo "✓ docker-compose.yml is valid"

      - name: Validate package.json files
        run: |
          node -e "require('./package.json')"
          node -e "require('./backend/package.json')"
          node -e "require('./frontend/package.json')"
          echo "✓ All package.json files are valid"

      - name: Check for secrets
        run: |
          # Check for common secrets patterns (exclude .github directory to avoid false positives)
          if grep -r "sk-" . --exclude-dir={node_modules,.git,.next,.github} || \
             grep -r "password.*=.*['\"]" . --exclude-dir={node_modules,.git,.next,.github} || \
             grep -r "token.*=.*['\"]" . --exclude-dir={node_modules,.git,.next,.github}; then
            echo "⚠️ Potential secrets found in code"
            exit 1
          fi
          echo "✓ No obvious secrets detected"

  commit-lint:
    name: Lint Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          # Get all commits in the PR
          COMMITS=$(git log --pretty=format:"%s" origin/main..HEAD)

          echo "Checking commit messages..."
          echo "$COMMITS"
          echo ""

          # Check if commits follow conventional format
          INVALID=0
          while IFS= read -r commit; do
            if ! echo "$commit" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?!?: .+"; then
              if ! echo "$commit" | grep -qE "^(Merge|Revert|Initial)"; then
                echo "❌ Invalid commit message: $commit"
                INVALID=1
              fi
            else
              echo "✓ Valid: $commit"
            fi
          done <<< "$COMMITS"

          if [ $INVALID -eq 1 ]; then
            echo ""
            echo "Some commit messages don't follow conventional commits format."
            echo "Please use: type(scope): description"
            echo "Types: feat, fix, docs, style, refactor, perf, test, chore"
            exit 1
          fi

          echo ""
          echo "✓ All commit messages are valid"

  status-check:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint, build, docker, validate, commit-lint]
    if: always()

    steps:
      - name: Check status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.docker.result }}" != "success" ] || \
             [ "${{ needs.validate.result }}" != "success" ] || \
             ( [ "${{ github.event_name }}" == "pull_request" ] && [ "${{ needs.commit-lint.result }}" != "success" ] ); then
            echo "❌ Some checks failed"
            exit 1
          fi
          echo "✓ All checks passed!"
